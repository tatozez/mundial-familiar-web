<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quiniela Mundial 2026</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { background: linear-gradient(135deg, #00ff87 0%, #60efff 100%); background-attachment: fixed; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin: 0; padding: 20px; }
        .contenedor { background-color: rgba(255, 255, 255, 0.95); max-width: 600px; margin: 0 auto; padding: 30px; border-radius: 20px; box-shadow: 0px 15px 25px rgba(0,0,0,0.2); }
        h1 { color: #1e3a8a; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        h3 { color: #333; }
        .etiqueta-hoy { display: inline-block; background-color: #e11d48; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; margin-bottom: 15px; letter-spacing: 1px;}
        .alerta-tiempo { background-color: #ffebee; color: #c62828; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 16px; display: none; margin-top: 15px; border: 2px solid #ef9a9a;}
        
        .caja-nombre { width: 80%; padding: 12px; font-size: 18px; margin-bottom: 20px; text-align: center; border: 2px solid #cbd5e1; border-radius: 12px; cursor: pointer; background-color: #f8fafc; }
        .partido { background-color: white; margin: 15px 0; padding: 20px; border-radius: 15px; border: 2px solid #e2e8f0; display: flex; justify-content: space-around; align-items: center; font-size: 18px; box-shadow: 0px 4px 6px rgba(0,0,0,0.05);}
        .caja-goles { width: 45px; padding: 8px; font-size: 22px; text-align: center; border-radius: 8px; border: 2px solid #94a3b8; font-weight: bold; color: #1e293b;}
        
        button { background-color: #4f46e5; color: white; border: none; padding: 12px 25px; font-size: 16px; border-radius: 12px; cursor: pointer; font-weight: bold; margin: 5px; transition: 0.3s; box-shadow: 0px 4px 10px rgba(79, 70, 229, 0.4);}
        button:hover { background-color: #4338ca; transform: translateY(-2px); }
        .boton-whatsapp { background-color: #25D366; width: 100%; font-size: 18px;} 
        .boton-whatsapp:hover { background-color: #1ebe5d; }
        .boton-tabla { background-color: #d946ef; width: 100%; margin-top: 25px; font-size: 20px; padding: 15px;}
        .boton-tabla:hover { background-color: #c026d3; }
        
        .zona-director { background-color: #1e293b; color: white; padding: 25px; margin-top: 40px; border-radius: 15px; box-shadow: inset 0px 4px 10px rgba(0,0,0,0.5);}
        .zona-director h3 { color: #38bdf8; margin-top: 0; }
        .selector-director { width: 100%; padding: 10px; font-size: 16px; margin-bottom: 15px; border-radius: 8px; }
        .boton-rojo { background-color: #dc2626; box-shadow: 0px 4px 10px rgba(220, 38, 38, 0.4); margin-top: 20px;}
        .boton-rojo:hover { background-color: #b91c1c; }
        
        .apuesta-guardada { background-color: #f8fafc; margin: 8px 0; padding: 12px; border-left: 6px solid #4f46e5; text-align: left; border-radius: 0 8px 8px 0; animation: aparecer 0.5s ease-out;}
        @keyframes aparecer { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .fila-posicion { display: flex; justify-content: space-between; background-color: #fff; border-bottom: 1px solid #f1f5f9; padding: 15px; font-size: 20px; align-items: center;}
        .fila-posicion:nth-child(1) { font-weight: bold; background: linear-gradient(to right, #fef08a, #fde047); border-radius: 12px; margin-bottom: 5px; border: 1px solid #facc15;} 
        .fila-posicion:nth-child(2) { background: linear-gradient(to right, #f1f5f9, #e2e8f0); border-radius: 12px; margin-bottom: 5px; border: 1px solid #cbd5e1;} 
        .fila-posicion:nth-child(3) { background: linear-gradient(to right, #fed7aa, #fdba74); border-radius: 12px; margin-bottom: 5px; border: 1px solid #fb923c;} 
    </style>
</head>
<body>
    <div class="contenedor">
        <h1>ğŸ† Quiniela 2026 âš½</h1>
        <div class="etiqueta-hoy">PARTIDO ACTIVO</div>
        
        <div class="partido" style="border-color: #4f46e5; border-width: 3px;">
            <span id="textoEquipo1">Cargando...</span>
            <input type="number" id="golesEq1" class="caja-goles" min="0" value="0">
            <span>vs</span>
            <input type="number" id="golesEq2" class="caja-goles" min="0" value="0">
            <span id="textoEquipo2">Cargando...</span>
        </div>

        <h3>Â¿QuiÃ©n estÃ¡ apostando?</h3>
        <select id="nombreApostador" class="caja-nombre">
            <option value="Roberto">Roberto</option>
            <option value="Melissa">Melissa (MamÃ¡)</option>
            <option value="Estuardo">Estuardo (PapÃ¡)</option>
            <option value="Luis">Luis (Hermano)</option>
        </select>

        <div id="alertaTiempoAgotado" class="alerta-tiempo">
            â³ Â¡TIEMPO AGOTADO! El partido ya empezÃ³ o ya terminÃ³.
        </div>

        <button id="botonGuardar" onclick="guardarApuesta()">Â¡Guardar Apuesta!</button>
        <button class="boton-whatsapp" onclick="copiarParaWhatsApp()" style="margin-top: 15px;">ğŸ“² Invitar por WhatsApp</button>

        <h3 style="margin-top: 30px;">ğŸ“¡ Apuestas Familiares (En Vivo):</h3>
        <div id="zonaDeApuestas">Cargando apuestas desde la nube...</div>

        <button class="boton-tabla" onclick="mostrarTabla()">ğŸ† Ver Tabla de Posiciones ğŸ†</button>
        <div id="zonaTabla" style="margin-top: 15px;"></div>

        <div class="zona-director">
            <h3>ğŸ‘‘ Control Remoto del Director</h3>
            <p style="font-size: 14px; color: #94a3b8;">Cambia el partido aquÃ­ y se actualizarÃ¡ en los celulares de tu familia.</p>
            
            <select id="selectorDirector" class="selector-director" onchange="cambiarPartidoEnLaNube()">
                <option value="0">ğŸ‡²ğŸ‡½ MÃ©xico vs SudÃ¡frica ğŸ‡¿ğŸ‡¦</option>
                <option value="1">ğŸ‡¨ğŸ‡¦ CanadÃ¡ vs Repesca UEFA ğŸ‡ªğŸ‡º</option>
                <option value="2">ğŸ‡ºğŸ‡¸ EE. UU. vs Paraguay ğŸ‡µğŸ‡¾</option>
                <option value="3">ğŸ‡§ğŸ‡· Brasil vs Marruecos ğŸ‡²ğŸ‡¦</option>
                <option value="4">ğŸ‡ªğŸ‡¸ EspaÃ±a vs Cabo Verde ğŸ‡¨ğŸ‡»</option>
                <option value="5">ğŸ‡¦ğŸ‡· Argentina vs Argelia ğŸ‡©ğŸ‡¿</option>
                <option value="6">âš½ Partido Vencido (Prueba)</option>
            </select>

            <hr style="border-color: #334155; margin: 20px 0;">
            
            <p style="margin-bottom: 5px;"><strong>Cerrar el partido y Repartir Puntos:</strong></p>
            <div class="partido" style="background-color: #0f172a; border: 1px solid #334155; margin-top: 0;">
                <span id="directorEq1">ğŸ‡²ğŸ‡½</span>
                <input type="number" id="realEq1" class="caja-goles" min="0" value="0" style="background: #1e293b; color: white;">
                <span>vs</span>
                <input type="number" id="realEq2" class="caja-goles" min="0" value="0" style="background: #1e293b; color: white;">
                <span id="directorEq2">ğŸ‡¿ğŸ‡¦</span>
            </div>
            <button onclick="calcularGanadores()" style="width: 100%; margin-top: 10px;">ğŸ¥‡ Â¡Repartir Puntos!</button>

            <button class="boton-rojo" onclick="reiniciarTodoElSistema()">ğŸ›‘ BORRAR TODAS LAS APUESTAS Y PUNTOS</button>
        </div>
    </div>

    <script>
        // 1. TUS LLAVES SECRETAS
        const firebaseConfig = {
          apiKey: "AIzaSyDlAsctjyrt4lW5UtRHfEHvH-70vxa_wxM",
          authDomain: "quiniela-familiar-7edd5.firebaseapp.com",
          projectId: "quiniela-familiar-7edd5",
          storageBucket: "quiniela-familiar-7edd5.firebasestorage.app",
          messagingSenderId: "1076654812047",
          appId: "1:1076654812047:web:850f1728a80b188a63b9fa"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();

        // 2. LA AGENDA
        let agenda = [
            { eq1: "MÃ©xico", band1: "ğŸ‡²ğŸ‡½", eq2: "SudÃ¡frica", band2: "ğŸ‡¿ğŸ‡¦", fechaLimite: new Date(2026, 5, 11, 13, 0) }, 
            { eq1: "CanadÃ¡", band1: "ğŸ‡¨ğŸ‡¦", eq2: "Repesca UEFA", band2: "ğŸ‡ªğŸ‡º", fechaLimite: new Date(2026, 5, 12, 15, 0) }, 
            { eq1: "EE. UU.", band1: "ğŸ‡ºğŸ‡¸", eq2: "Paraguay", band2: "ğŸ‡µğŸ‡¾", fechaLimite: new Date(2026, 5, 12, 18, 0) }, 
            { eq1: "Brasil", band1: "ğŸ‡§ğŸ‡·", eq2: "Marruecos", band2: "ğŸ‡²ğŸ‡¦", fechaLimite: new Date(2026, 5, 13, 18, 0) }, 
            { eq1: "EspaÃ±a", band1: "ğŸ‡ªğŸ‡¸", eq2: "Cabo Verde", band2: "ğŸ‡¨ğŸ‡»", fechaLimite: new Date(2026, 5, 15, 10, 0) }, 
            { eq1: "Argentina", band1: "ğŸ‡¦ğŸ‡·", eq2: "Argelia", band2: "ğŸ‡©ğŸ‡¿", fechaLimite: new Date(2026, 5, 16, 21, 0) }, 
            { eq1: "Prueba", band1: "âš™ï¸", eq2: "Vencido", band2: "â±ï¸", fechaLimite: new Date(2023, 0, 1, 12, 0) } 
        ];

        let memoriaApuestas = [];
        let puntuacionFamiliar = { "Roberto": 0, "Melissa": 0, "Estuardo": 0, "Luis": 0 };
        let escuchadorApuestas = null;
        let partidoActivoId = 0; // Por defecto el 0

        // ESCUCHAR LA TABLA DE POSICIONES
        db.collection("sistema").doc("ranking").onSnapshot((doc) => {
            if (doc.exists) {
                puntuacionFamiliar = doc.data();
                mostrarTabla();
            } else {
                db.collection("sistema").doc("ranking").set(puntuacionFamiliar);
            }
        });

        // ESCUCHAR EL CONTROL REMOTO DEL DIRECTOR
        db.collection("sistema").doc("controlRemoto").onSnapshot((doc) => {
            if (doc.exists) {
                partidoActivoId = doc.data().partidoActual;
                document.getElementById("selectorDirector").value = partidoActivoId; // Actualiza tu menÃº
                cargarPartido(partidoActivoId); // Actualiza la pantalla de todos
            } else {
                db.collection("sistema").doc("controlRemoto").set({ partidoActual: 0 });
            }
        });

        // EL DIRECTOR CAMBIA EL PARTIDO
        function cambiarPartidoEnLaNube() {
            let nuevoId = document.getElementById("selectorDirector").value;
            db.collection("sistema").doc("controlRemoto").update({ partidoActual: parseInt(nuevoId) });
        }

        function cargarPartido(id) {
            let partido = agenda[id];

            document.getElementById("textoEquipo1").innerHTML = partido.band1 + " <strong>" + partido.eq1 + "</strong>";
            document.getElementById("textoEquipo2").innerHTML = "<strong>" + partido.eq2 + "</strong> " + partido.band2;
            document.getElementById("directorEq1").innerHTML = partido.band1;
            document.getElementById("directorEq2").innerHTML = partido.band2;

            if (new Date() > partido.fechaLimite) {
                document.getElementById("botonGuardar").style.display = "none";
                document.getElementById("alertaTiempoAgotado").style.display = "block";
            } else {
                document.getElementById("botonGuardar").style.display = "inline-block";
                document.getElementById("alertaTiempoAgotado").style.display = "none";
            }

            if(escuchadorApuestas) escuchadorApuestas(); 
            
            // Cargar apuestas solo de este partido
            escuchadorApuestas = db.collection("apuestas").where("partidoId", "==", id.toString()).onSnapshot((snapshot) => {
                let texto = "";
                memoriaApuestas = [];
                snapshot.forEach((doc) => {
                    let apuesta = doc.data();
                    memoriaApuestas.push(apuesta);
                    texto += `<div class='apuesta-guardada'><strong>${apuesta.nombrePersona}:</strong> ${partido.eq1} ${apuesta.goles1} - ${apuesta.goles2} ${partido.eq2}</div>`;
                });
                document.getElementById("zonaDeApuestas").innerHTML = texto || "AÃºn no hay apuestas para este partido...";
            });
        }

        function copiarParaWhatsApp() {
            let partido = agenda[partidoActivoId];
            let urlApp = window.location.href; 
            let mensaje = `ğŸ† Â¡Quiniela Familiar 2026! âš½\n\nEl partido ACTIVO para apostar es:\n${partido.band1} ${partido.eq1} vs ${partido.eq2} ${partido.band2}\n\nğŸ‘‰ Entra aquÃ­ a poner tu apuesta:\n${urlApp}`;
            navigator.clipboard.writeText(mensaje);
            Swal.fire('Â¡Copiado!', 'El link y el partido ya estÃ¡n copiados para WhatsApp.', 'success');
        }

        function guardarApuesta() {
            let nombre = document.getElementById("nombreApostador").value;
            let gEq1 = document.getElementById("golesEq1").value;
            let gEq2 = document.getElementById("golesEq2").value;

            db.collection("apuestas").add({
                nombrePersona: nombre,
                partidoId: partidoActivoId.toString(),
                goles1: gEq1,
                goles2: gEq2,
                fecha: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            document.getElementById("golesEq1").value = 0;
            document.getElementById("golesEq2").value = 0;
            Swal.fire({ position: 'top-end', icon: 'success', title: 'Apuesta enviada a la nube â˜ï¸', showConfirmButton: false, timer: 1500 });
        }

        function calcularGanadores() {
            let real1 = document.getElementById("realEq1").value;
            let real2 = document.getElementById("realEq2").value;
            let alguienGano = false;

            for (let i = 0; i < memoriaApuestas.length; i++) {
                let apuesta = memoriaApuestas[i];
                if (apuesta.goles1 === real1 && apuesta.goles2 === real2) {
                    puntuacionFamiliar[apuesta.nombrePersona] += 3;
                    alguienGano = true;
                }
            }

            db.collection("sistema").doc("ranking").set(puntuacionFamiliar);

            if (alguienGano) {
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.5 }, zIndex: 9999 });
                Swal.fire('Â¡TENEMOS GANADOR!', 'Los puntos han sido sumados a la tabla global.', 'success');
            } else {
                Swal.fire('Â¡Fin del partido!', 'Nadie adivinÃ³ el resultado esta vez.', 'info');
            }
        }

        function mostrarTabla() {
            let lista = [
                { nombre: "Roberto", puntos: puntuacionFamiliar["Roberto"] },
                { nombre: "Melissa", puntos: puntuacionFamiliar["Melissa"] },
                { nombre: "Estuardo", puntos: puntuacionFamiliar["Estuardo"] },
                { nombre: "Luis", puntos: puntuacionFamiliar["Luis"] }
            ];
            lista.sort(function(a, b) { return b.puntos - a.puntos });
            let htmlTabla = "<h3 style='color: #c026d3;'>ğŸŒŸ Ranking Familiar ğŸŒŸ</h3>";
            for (let i = 0; i < lista.length; i++) {
                htmlTabla += `<div class='fila-posicion'><span>${i+1}Â° ${lista[i].nombre}</span><span><strong>${lista[i].puntos} pts</strong></span></div>`;
            }
            document.getElementById("zonaTabla").innerHTML = htmlTabla;
        }

        // EL BOTÃ“N ROJO DE EMERGENCIA
        function reiniciarTodoElSistema() {
            Swal.fire({
                title: 'Â¿EstÃ¡s completamente seguro?',
                text: "Esto va a borrar TODAS las apuestas de todos los partidos y regresarÃ¡ los puntos a CERO. Â¡No hay vuelta atrÃ¡s!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#334155',
                confirmButtonText: 'SÃ­, Â¡borrar todo!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // 1. Regresar puntos a 0
                    let ceros = { "Roberto": 0, "Melissa": 0, "Estuardo": 0, "Luis": 0 };
                    db.collection("sistema").doc("ranking").set(ceros);
                    
                    // 2. Borrar todas las apuestas de la nube
                    db.collection("apuestas").get().then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            doc.ref.delete();
                        });
                    });

                    Swal.fire('Â¡Sistema Reiniciado!', 'El pizarrÃ³n estÃ¡ totalmente limpio y listo para el Mundial real.', 'success');
                }
            })
        }
    </script>
</body>
</html>